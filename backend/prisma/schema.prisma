generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  user
}

enum UserStatus {
  active
  suspended
}

enum CreditTransactionType {
  grant
  deduction
  refund
}

model User {
  id           String     @id @default(uuid()) @db.Uuid
  email        String     @unique
  username     String     @unique
  passwordHash String     @map("password_hash")
  role         UserRole   @default(user)
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  credits      UserCredits?
  transactions CreditTransaction[]
  apiKeys      ApiKey[]
  apiRequests  ApiRequest[]
  blogPosts    BlogPost[]

  @@map("users")
}

model UserCredits {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @unique @map("user_id") @db.Uuid
  balance       Decimal  @default(0) @db.Decimal(12, 4)
  totalPurchased Decimal @default(0) @map("total_purchased") @db.Decimal(12, 4)
  totalConsumed Decimal  @default(0) @map("total_consumed") @db.Decimal(12, 4)
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_credits")
}

model CreditTransaction {
  id           String                @id @default(uuid()) @db.Uuid
  userId       String                @map("user_id") @db.Uuid
  type         CreditTransactionType
  amount       Decimal               @db.Decimal(12, 4)
  balanceAfter Decimal               @map("balance_after") @db.Decimal(12, 4)
  description  String?
  metadata     Json?                 @db.JsonB
  createdAt    DateTime              @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("credit_transactions")
}

model ApiKey {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  keyHash       String    @map("key_hash")
  keyPrefix     String    @map("key_prefix")
  name          String
  allowedModels Json?     @map("allowed_models") @db.JsonB
  quotaLimit    Int?      @map("quota_limit")
  quotaUsed     Int       @default(0) @map("quota_used")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  revokedAt     DateTime? @map("revoked_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiRequests ApiRequest[]

  @@index([keyHash])
  @@index([userId])
  @@map("api_keys")
}

model ShadowModel {
  id              String   @id @default(uuid()) @db.Uuid
  displayName     String   @unique @map("display_name")
  providerBaseUrl String   @map("provider_base_url")
  providerToken   String   @map("provider_token")
  providerModel   String   @map("provider_model")
  pricingInput    Decimal  @map("pricing_input") @db.Decimal(12, 8)
  pricingOutput   Decimal  @map("pricing_output") @db.Decimal(12, 8)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  apiRequests ApiRequest[]

  @@map("shadow_models")
}

model ApiRequest {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  apiKeyId     String   @map("api_key_id") @db.Uuid
  modelId      String   @map("model_id") @db.Uuid
  tokensInput  Int      @map("tokens_input")
  tokensOutput Int      @map("tokens_output")
  cost         Decimal  @db.Decimal(12, 6)
  statusCode   Int      @map("status_code")
  durationMs   Int      @map("duration_ms")
  ipAddress    String?  @map("ip_address")
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey      @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  model  ShadowModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([apiKeyId, createdAt])
  @@index([modelId, createdAt])
  @@map("api_requests")
}

// ===========================================
// System Settings
// ===========================================
model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique
  value       String   @db.Text
  category    String   // 'environment', 'connection', 'system'
  dataType    String   @default("string") @map("data_type") // 'string', 'number', 'boolean', 'json'
  isSecret    Boolean  @default(false) @map("is_secret")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("system_settings")
}

// ===========================================
// Blog Posts for Guides/Documentation
// ===========================================
model BlogPost {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  slug        String    @unique
  excerpt     String?   @db.Text
  content     String    @db.Text
  coverImage  String?   @map("cover_image")
  authorId    String    @map("author_id") @db.Uuid
  isPublished Boolean   @default(false) @map("is_published")
  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isPublished, publishedAt])
  @@map("blog_posts")
}
